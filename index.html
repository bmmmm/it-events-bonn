<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>it-events-bonn</title>

  <!-- FullCalendar core (CSS & JS) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>

  <!-- ical.js for parsing .ics feeds -->
  <script src="https://cdn.jsdelivr.net/npm/ical.js@1.4.0/build/ical.min.js"></script>

  <!-- Inter font & minimal styling -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&display=swap" rel="stylesheet" />

  <style>
    :root {
      --bg: #f9fafb;
      --fg: #111827;
      --card: #ffffff;
      --border: #e5e7eb;
    }
    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #111827;
        --fg: #f9fafb;
        --card: #1f2937;
        --border: #374151;
      }
    }
    html, body {
      height: 100%;
      margin: 0;
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
      background: var(--bg);
      color: var(--fg);
      -webkit-font-smoothing: antialiased;
    }
    #calendar {
      max-width: 1100px;
      margin: 0 auto;
      padding: 1.5rem 1rem 2.5rem;
    }
    .fc {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 1rem;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.04);
    }
  </style>
</head>
<body>

  <div id="status" style="padding: 1rem; background: #f3f4f6; font-size: 0.9rem;"></div>

  <main>
    <div id="calendar"></div>
  </main>

  <script>
  // ───────────────────────────────────────────────────────
  // Parst .ics → FullCalendar-Event-Objekte mit nützlichen Feldern
  async function loadIcsEvents(calendar) {
    const response = await fetch(calendar.url);
    if (!response.ok) throw new Error(response.status + ' ' + response.statusText);
    const icsText = await response.text();
    const jcalData = ICAL.parse(icsText);
    const comp = new ICAL.Component(jcalData);
    const vevents = comp.getAllSubcomponents('vevent') || [];
    const events = [];
    vevents.forEach((ve) => {
      const ev = new ICAL.Event(ve);
      // URL vorbereiten: Wenn keine führende HTTP(S)-Angabe, prefix hinzufügen
      if (ev.url && !/^https?:\/\//i.test(ev.url)) {
        ev.url = 'http://' + ev.url;
      }
      if (!ev.summary || !ev.startDate) return;
      events.push({
        id: ev.uid || Math.random().toString(36).slice(2),
        title: ev.summary,
        start: ev.startDate.toJSDate(),
        end: ev.endDate ? ev.endDate.toJSDate() : null,
        backgroundColor: calendar.color,
        borderColor: calendar.color,
        extendedProps: {
          calendar: calendar.name,
          location: ev.location || '',
          url: ev.url || '',
          description: ev.description || ''
        }
      });
    });
    return events;
  }

  // ───────────────────────────────────────────────────────
  // Dynamisch alle Kalender-Namen aus last_updates.json ermitteln
  async function getCalendars() {
    try {
      const res = await fetch('last_updates.json');
      if (!res.ok) return [];
      const data = await res.json();
      return Object.keys(data).map((name) => ({
        name,
        url: `calendars/${name}.ics`,
        color: '#3788d8' // Standardfarbe; bei Bedarf anpassen oder erweitern
      }));
    } catch (err) {
      console.error('Fehler beim Laden von last_updates.json', err);
      return [];
    }
  }

  // ───────────────────────────────────────────────────────
  // Initialisiere FullCalendar mit List-Ansicht und lade alle Kalender
  document.addEventListener('DOMContentLoaded', async function () {
    const calendars = await getCalendars();
    const statuses = {};

    // Container für Statusmeldung
    const statusEl = document.getElementById('status');
    statusEl.textContent = 'Lade Kalender...';

    // Initialisiere FullCalendar
    const calendarEl = document.getElementById('calendar');
    const calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: 'listMonth',
      height: 'auto',
      locale: 'de',
      headerToolbar: {
        left: 'prev,next today',
        center: 'title',
        right: 'dayGridMonth,listMonth'
      },
      eventDisplay: 'block',
      eventClick(info) {
        const e = info.event;
        let details = e.title + '\n\n' + e.start.toLocaleString();
        if (e.end) details += ' – ' + e.end.toLocaleString();
        if (e.extendedProps.location) details += '\nOrt: ' + e.extendedProps.location;
        if (e.extendedProps.url) details += '\nWeb: ' + e.extendedProps.url;
        if (e.extendedProps.description) details += '\n\n' + e.extendedProps.description;
        alert(details);
      },
      eventContent(arg) {
        const parts = [];
        parts.push({ html: '<b>' + arg.event.title + '</b>' });
        if (arg.event.extendedProps.url) {
          const url = arg.event.extendedProps.url;
          parts.push({ html: '<div><a href="' + url + '" target="_blank" style="font-size:0.85em; color:#2563eb;">' + url + '</a></div>' });
        }
        return { domNodes: parts.map(p => {
            const el = document.createElement('div');
            el.innerHTML = p.html;
            return el;
          })
        };
      }
    });

    // Lade jeden Kalender, aktualisiere Status und füge Events hinzu
    for (const cal of calendars) {
      try {
        const events = await loadIcsEvents(cal);
        statuses[cal.name] = 'reachable';
        calendar.addEventSource(events);
      } catch (err) {
        statuses[cal.name] = 'not reachable';
      }
    }

    // Status-Zusammenfassung ausgeben
    const lines = Object.keys(statuses).map(name => {
      const stat = statuses[name];
      const color = stat === 'reachable' ? '#16a34a' : '#dc2626';
      return '<span style="color:' + color + '">' + name + ': ' + stat + '</span>';
    });
    statusEl.innerHTML = 'Kalender-Status: ' + lines.join(' | ');

    calendar.render();
  });
  </script>
</body>
</html>